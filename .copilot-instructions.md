# pplx-spa-assets-knowledge Development Instructions

## Overview

This is a multi-stage TypeScript project for analyzing Perplexity AI SPA static assets and generating:
1. Structured knowledge bases
2. OpenAPI v3.1 / AsyncAPI v3.0 / JSON Schema specifications
3. MCP (Model Context Protocol) servers
4. automcp configurations

## Project Structure

```
src/
├── fetchers/
│   └── asset-fetcher.ts          # Download SPA assets from CDN
├── parsers/
│   ├── asset-parser.ts           # Basic chunking parser
│   └── typescript-ast-parser.ts   # AST-based TypeScript parsing (ts-morph)
├── generators/
│   ├── openapi-generator.ts       # OpenAPI v3.1 specs
│   ├── asyncapi-generator.ts      # AsyncAPI v3.0 specs
│   ├── jsonschema-generator.ts    # JSON Schema definitions
│   └── automcp-generator.ts       # MCP server code generation
├── knowledge/
│   └── kb-builder.ts              # Knowledge base construction
├── types/
│   └── index.ts                   # Shared TypeScript definitions
└── cli.ts                         # Command-line interface
```

## Development Workflow

### Setting Up

```bash
# Clone and install
git clone https://github.com/pv-udpv/pplx-spa-assets-knowledge
cd pplx-spa-assets-knowledge
npm install

# Create .env for testing
echo "API_BASE_URL=https://pplx-next-static-public.perplexity.ai" > .env
echo "API_KEY=" >> .env
```

### Build and Test

```bash
npm run build
npm run dev  # Watch mode
```

### CLI Commands

#### 1. Fetch Assets
```bash
npm run fetch -- \
  --source https://pplx-next-static-public.perplexity.ai \
  --output ./assets-cache \
  --concurrency 5
```

#### 2. Parse TypeScript Files
```bash
npm run parse -- \
  --input ./assets-cache \
  --output ./parsed
```

#### 3. Generate Specifications
```bash
# Generate all specs
npm run generate -- \
  --type all \
  --input ./parsed \
  --output ./specs

# Or specific types
npm run generate -- --type openapi
npm run generate -- --type asyncapi
npm run generate -- --type jsonschema
```

#### 4. Generate MCP Server
```bash
npm run mcp:generate -- \
  --spec ./specs/openapi/api-v1.yaml \
  --output ./mcp/pplx-api \
  --name pplx-api
```

#### 5. Generate automcp Config
```bash
node dist/cli.js automcp \
  --spec ./specs/openapi/api-v1.yaml \
  --output ./automcp.config.json
```

## Key Technologies

- **ts-morph** - TypeScript AST parsing and code generation
- **@modelcontextprotocol/sdk** - MCP protocol implementation
- **openapi-types** - Type definitions for OpenAPI specs
- **@asyncapi/parser** - AsyncAPI spec support
- **commander** - CLI framework
- **yaml** - YAML serialization

## Architecture Decisions

### AST-Based Parsing
- Uses `ts-morph` for accurate TypeScript AST extraction
- Supports interfaces, type aliases, classes, enums, functions
- Extracts JSDoc comments for documentation
- Pattern-matches common API call patterns (fetch, axios)

### Spec Generation
- **OpenAPI**: REST API endpoints with request/response schemas
- **AsyncAPI**: WebSocket and event-driven endpoints
- **JSON Schema**: Type definitions extracted from TypeScript AST

### MCP Server Generation
- Generates full Node.js MCP server from OpenAPI specs
- Includes:
  - `package.json` with dependencies
  - `src/index.ts` - MCP server with tool registration
  - `src/tools.ts` - Tool implementations with API calls
  - `src/types.ts` - Type definitions from OpenAPI schemas
  - `README.md` and `.env.example`

### automcp Integration
- Generates automcp-compatible configuration
- Supports environment variables for API keys and base URLs
- Integrates with existing automcp tooling

## Common Tasks

### Add New Generator

1. Create file in `src/generators/`
2. Implement interface with `generate()` method
3. Add to CLI in `src/cli.ts`

### Add New Asset Type

1. Update `AssetChunk.type` in `src/types/index.ts`
2. Add detection logic in `AssetParser.detectContentType()`
3. Implement chunking strategy in `chunkifyAsset()`

### Add New API Pattern

Update `TypeScriptASTParser.extractEndpointFromFunction()` with new regex patterns:

```typescript
const patterns = [
  { regex: /new_library\.method\s*\(\s*['"]([^'"]+)['"]/g, type: 'new_library' },
  // ...
];
```

## Testing

### Manual Testing

```bash
# Fetch a small subset
echo "/_next/static/chunks/main.js" > manifest.txt
npm run fetch -- --manifest manifest.txt

# Parse fetched assets
npm run parse -- --input ./assets-cache

# Generate specs
npm run generate -- --input ./parsed

# Generate MCP
npm run mcp:generate -- --spec ./specs/openapi/api-v1.yaml
```

## Performance Considerations

- **Asset Fetching**: Uses concurrent downloads with exponential backoff
- **AST Parsing**: Single-threaded but fast for typical bundle sizes
- **Spec Generation**: Creates separate files per type for better maintainability
- **Memory**: Watch out for large bundles (>100MB) - may need chunking

## Debugging

```bash
# Enable verbose logging (TODO: implement)
DEBUG=pplx-assets:* npm run fetch

# Check generated MCP server
cd ./mcp/pplx-api
npm run build
node dist/index.js
```

## Contributing

1. Branch from `main`
2. Implement feature/fix
3. Update docs if needed
4. Test with `npm run build`
5. Submit PR

## Known Issues & TODOs

- [ ] Implement real asset manifest fetching (currently placeholder)
- [ ] Add directory traversal for batch file parsing
- [ ] Implement GraphRAG for knowledge graph
- [ ] Add CI/CD pipeline with GitHub Actions
- [ ] Semantic diff tracking for API changes
- [ ] WebSocket endpoint extraction
- [ ] Custom hook for additional pattern detection

## References

- [OpenAPI v3.1 Spec](https://spec.openapis.org/oas/v3.1.0)
- [AsyncAPI v3.0 Spec](https://www.asyncapi.com/en/docs/specifications/v3.0.0)
- [MCP Protocol](https://modelcontextprotocol.io/)
- [ts-morph Documentation](https://ts-morph.com/)
